version: "3"
services:
    mysql_master:
        image: mysql:5.7.27
        hostname: ${MASTER_HOSTNAME}
        ports:
            - 33066:3306
        volumes:
            - ./master/etc/mysql/conf.d:/etc/mysql/conf.d:ro
            - ./master/user/share/zoneinfo/:/usr/share/zoneinfo:ro
            - ./master/var/lib/mysql:/var/lib/mysql:rw
            - ./master/var/log/mysql:/var/log/mysql:rw
            - ./master/var/run/mysql:/var/run/mysql:rw
        environment:
            MYSQL_ROOT_PASSWORD: ${MASTER_ROOT_PASSWORD}
    mysql_slave:
        image: mysql:5.7.27
        hostname: ${SLAVE_HOSTNAME}
        ports:
            - 33067:3306
        volumes:
            - ./slave/etc/mysql/conf.d:/etc/mysql/conf.d:ro
            - ./slave/user/share/zoneinfo/:/usr/share/zoneinfo:ro
            - ./slave/var/lib/mysql:/var/lib/mysql:rw
            - ./slave/var/log/mysql:/var/log/mysql:rw
            - ./slave/var/run/mysql:/var/run/mysql:rw
        environment:
            MYSQL_ROOT_PASSWORD: ${SLAVE_ROOT_PASSWORD}
        depends_on:
            - mysql_master
    mysql_repliation_setup:
        image: ubuntu:18.04
        volumes:
            - ./scripts:/opt/scripts
        depends_on:
            - mysql_master
            - mysql_slave
        environment:
            MASTER_HOSTNAME: ${MASTER_HOSTNAME}
            MASTER_ROOT_USER: ${MASTER_ROOT_USER}
            MASTER_ROOT_PASSWORD: ${MASTER_ROOT_PASSWORD}

            SLAVE_HOSTNAME: ${SLAVE_HOSTNAME}
            SLAVE_ROOT_PASSWORD: ${SLAVE_ROOT_PASSWORD}
            SLAVE_REPL_USER: ${SLAVE_REPL_USER}
            SLAVE_REPL_PASSWORD: ${SLAVE_REPL_PASSWORD}
        command: bash /opt/scripts/mysql-setup-replication.sh
